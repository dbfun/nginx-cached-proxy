# Повышение доступности веб-сервисов

Встала задача повысить доступность веб-сайта, основанного на веб-сервисах (1С, CRM, другие системы, использующие `HTTP`).

С одной стороны, можно кешировать данные на стороне клиента (в браузере).

С другой стороны, есть серверные middleware, которые самостоятельно не могут кешировать данные. Пример: сервис получает информацию из нескольких источников, обрабатывает ее и формирует агрегированные данные. Если один из источников не работает, не работает весь сервис. Вообще, существуют такие проблемы с источниками данных:

* недоступен в течение нескольких секунд или часов
* отвечает слишком долго, соединение закрывается по таймауту

Наконец, есть данные, общие для всех пользователей, их можно получить один раз из веб-сервиса и передавать нескольким клиентам.

Поэтому клиентское кеширование подходит не во всех случаях, и нужно организовать серверное кеширование.

Пожелания:

* запрашивать данные каждый раз (он-лайн), но если веб-сервис "молчит" / ошибка / таймаут - показывать последние (из кеша)
* выводить пометку "данные обновлены ..." для устаревших данных из кеша
* возможность форсировать кеширование вне зависимости от установки кукисов и запрещающих заголовков кеширования
* возможность конфигурирования для различных веб-сервисов
  * срок хранения данных
  * возможность игнорирования заголовков и кукисов
  * ограничение максимального размера данных
  * опция "обновить в фоне"

Именно для этого предусмотрены такие параметры кеширования: `stale-if-error` и `stale-while-revalidate`, их нужно указывать в заголовке `Cache-Control`. Однако не все веб-сервисы их выставляют, и наоборот, могут вернуть `no-cache`, но данные все-таки нужно положить в кеш на случай отказа.

Поэтому я сделал тестовый стенд для изучения этих вопросов, который состоит из:

* веб-сервиса `test-endpoint`, который может эмулировать отказы
* клиента `test-client`, который показывает полученные данные и HTTP код
* прокси, который должен кешировать данные и таким образом повышать доступность


# Компоненты системы

## Сервер test-endpoint

Тестовый сервер, работу которого надо "стабилизировать".

Имеет несколько вариантов использования (`GET /some-uri`):

* `/healthcheck` - проверка здоровья, "200 OK" абсолютно всегда
* `/always/{HTTP код}` - всегда возвращать определенный код, например `/always/503`
* `/timeout` - 500 по таймауту
* `/slow/{задержка в сек}` - "200 OK" с указанной задержкой (если не отвалится раньше по таймауту)
* `/random/{вероятность 200 OK в %}` 200/404 с вероятностью выпадения "200 OK" в %
* `/cycle/{причина отказа: timeout, error, blackhole}/{время работы в сек}/{время отказа в сек}` - "циклический отказ" - наиболее вероятный вариант работы неустойчивых сервисов, когда промежуток "работает" сменяется промежутком "не работает". Пример: `/cycle/error/10/5` - работоспособность "200 OK" в течение 10 сек, затем отказ "500" продолжительностью 5 сек. `timeout` - отказ по таймауту, `blackhole` - сервер "молчит", клиент сам должен разорвать соединение


Настройка осуществляется через переменные окружения.

| Переменная окружения     | Описание                                         | Примечание                                                                                                                                                                  |
|--------------------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| port                     | порт                                             |                                                                                                                                                                             |
| endpoint_timeout         | timeout endpoint сервера в мс                    |                                                                                                                                                                             |
| set_cookie               | включить установку кукисов (`on`, `off`)         | Будут установлены куки через `Set-Cookie`                                                                                                                                   |
| set_no_cache_and_expired | включить установку заголовков против кеширования | Будут установлены заголовки против кеширования `Cache-Control: no-cache, must-revalidate`, `Pragma: no-cache`, `Expires: Fri, 30 Oct 1998 14:19:41 GMT`, `Vary: User-Agent` |
| set_header_cache_control | указать заголовок для кеширования                | Можно установить такой заголовок `Cache-Control`: `max-age=0, stale-if-error=3600`                                                                                          |
| document                 | схема документа, который будет отправлен         | Пример: `n,msg,guid,now,uptime`; `n` - номер обращения, `msg` - сообщение, `guid` - случайный guid, `now` - текущее время, `uptime` - время работы сервиса в сек            |

Несколько примеров:

```
curl -i http://test-endpoint/healthcheck

HTTP/1.1 200 OK
...
{"n":35,"msg":"ok","guid":"6efff51d-1d72-45d7-93a9-d47d9e3a7e04","now":"2019-07-10T07:28:06.740Z","uptime":"45 seconds"}
```

```
curl -i http://test-endpoint/timeout

HTTP/1.1 500 Internal Server Error
...
{"n":177,"msg":"Something went wrong","guid":"e18eae8a-296a-4037-88a3-41cc0e2232b8","now":"2019-07-10T07:31:11.547Z","uptime":"230 seconds"}
```

Тут, в зависимости от аптайма, сначала "200 OK", а через 4 секунды - "500 Internal Server Error":

```
curl -i http://test-endpoint/cycle/error/4/4

HTTP/1.1 200 OK
...
{"n":260,"msg":"ok","guid":"821dbd44-67b0-4c90-aaa5-08aa4ea5121c","now":"2019-07-10T07:32:59.626Z","uptime":"338 seconds"}


curl -i http://test-endpoint/cycle/error/4/4

HTTP/1.1 500 Internal Server Error
...
{"n":264,"msg":"Something went wrong","guid":"142774e9-cad7-42de-b22c-1d5b70652561","now":"2019-07-10T07:33:03.457Z","uptime":"342 seconds"}
```

## Клиент

Настройка также осуществляется через переменные окружения.


| Настройка           | Описание                                                                                                |
|---------------------|---------------------------------------------------------------------------------------------------------|
| endpoint_uri        | точка для тестирования (backend)                                                                        |
| client_max_time     | timeout клиента, сек                                                                                    |
| client_req_interval | частота опроса сервера, мс                                                                              |
| resp_check_type     | выбор между параллельным (`parallel`) и последовательным (`serial`) выполнением запросов                |
| http_proxy          | прокси, с помощью которого реализуется стратегия стабилизации работы; его можно отключить для сравнения |
| send_cookie         | включить передачу кукисов (`on`, `off`)                                                                 |
| show_headers        | показывать заголовки ответа (`on`, `off`)                                                               |

## Прокси

Его нужно указать в качестве `http_proxy` в настройке клиента. На выбор: nginx, varnish (`WIP`: еще не сделано), squid. Все настройки производятся в файлах конфигурации соответствующих серверов, там же есть комментарии.

# Демо

## Без прокси

![no_proxy](https://raw.githubusercontent.com/dbfun/nginx-cached-proxy/master/assets/no_proxy.gif)

## Nginx


![nginx](https://raw.githubusercontent.com/dbfun/nginx-cached-proxy/master/assets/nginx.gif)

## Squid

![squid](https://raw.githubusercontent.com/dbfun/nginx-cached-proxy/master/assets/squid.gif)




# Ссылки

* [Семь отличных ускорителей сайтов для Linux и Unix](https://habr.com/ru/company/ruvds/blog/320318/)
* [Serving stale content](https://docs.fastly.com/guides/performance-tuning/serving-stale-content)
* [The stale-if-error Cache-Control Extension](https://tools.ietf.org/html/rfc5861#section-4)
* [Squid: Two HTTP Caching Extensions](https://www.mnot.net/blog/2007/12/12/stale)
* [Squid: Masking Latency & Failures with Squid](https://www.igvita.com/2009/08/05/masking-latency-failures-with-squid/)
